<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Frota</title>
    <!-- Carrega o Tailwind CSS para o estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega as bibliotecas do React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Carrega o Babel para traduzir o código do React para o navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background-color: #111827; /* bg-gray-900 */
      }
      @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
      .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
      @keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
      .animate-fade-in-down { animation: fade-in-down 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <!-- O React vai renderizar o aplicativo dentro desta div -->
    <div id="root"></div>

    <!-- CÓDIGO DO APLICATIVO REACT EMBUTIDO -->
    <script type="text/babel">
        // Componentes de Ícones (SVG)
        const Icon = ({ children, size = 20, color = 'currentColor', strokeWidth = 2 }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke={color}
                strokeWidth={strokeWidth}
                strokeLinecap="round"
                strokeLinejoin="round"
            >
                {children}
            </svg>
        );

        const Truck = (props) => (
            <Icon {...props}>
                <path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11" />
                <path d="M14 9h4l4 4v4h-8v-4h-4V9Z" />
                <circle cx="7.5" cy="18.5" r="2.5" />
                <circle cx="17.5" cy="18.5" r="2.5" />
            </Icon>
        );
        const Wrench = (props) => (
            <Icon {...props}>
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
            </Icon>
        );
        const Fuel = (props) => (
            <Icon {...props}>
                <line x1="3" y1="22" x2="15" y2="22" /><line x1="4" y1="9" x2="4" y2="22" /><path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18" /><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2" /><path d="M18 12h.01" />
            </Icon>
        );
        const FileText = (props) => (
            <Icon {...props}>
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" />
            </Icon>
        );
        const AlertTriangle = (props) => (
            <Icon {...props}>
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" />
            </Icon>
        );
        const LayoutDashboard = (props) => (
            <Icon {...props}>
                <rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /><rect x="14" y="14" width="7" height="7" />
            </Icon>
        );
        const Plus = (props) => (
            <Icon {...props}>
                <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
            </Icon>
        );
        const Trash2 = (props) => (
            <Icon {...props}>
                <path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" />
            </Icon>
        );
        const Edit = (props) => (
            <Icon {...props}>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
            </Icon>
        );
        const CircleDollarSign = (props) => (
            <Icon {...props}>
                <circle cx="12" cy="12" r="10" /><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8" /><path d="M12 18V6" />
            </Icon>
        );
        const TrendingUp = (props) => (
            <Icon {...props}>
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" />
            </Icon>
        );

        // Funções Auxiliares para o Local Storage
        const useLocalStorage = (key, initialValue) => {
          const [storedValue, setStoredValue] = React.useState(() => {
            try {
              const item = window.localStorage.getItem(key);
              return item ? JSON.parse(item) : initialValue;
            } catch (error) {
              console.error(error);
              return initialValue;
            }
          });

          const setValue = (value) => {
            try {
              const valueToStore = value instanceof Function ? value(storedValue) : value;
              setStoredValue(valueToStore);
              window.localStorage.setItem(key, JSON.stringify(valueToStore));
            } catch (error) {
              console.error(error);
            }
          };
          return [storedValue, setValue];
        };

        // Dados Iniciais de Exemplo
        const initialVehicles = [
            { id: 1, name: 'Scania R450', plate: 'ETS-2024', driver: 'João Silva', status: 'Em Rota', km: 125450 },
            { id: 2, name: 'Volvo FH540', plate: 'EAA-1530', driver: 'Carlos Souza', status: 'Na Garagem', km: 89525 },
            { id: 3, name: 'Mercedes Actros', plate: 'BR-040', driver: 'Ana Costa', status: 'Em Manutenção', km: 210000 },
        ];

        const initialTrips = [
            { id: 1, vehicleId: 1, driver: 'João Silva', client: 'TransJóia', cargo: 'Soja', tonnage: 22, origin: 'São Paulo', destination: 'Rio de Janeiro', kmInicial: 125000, kmFinal: 125450, fuel: 150, date: '2024-07-25', revenue: 3500, status: 'Finalizada' },
            { id: 2, vehicleId: 2, driver: 'Carlos Souza', client: 'Carga Pesada Ltda', cargo: 'Eletrônicos', tonnage: 18, origin: 'Belo Horizonte', destination: 'Vitória', kmInicial: 89525, kmFinal: null, fuel: null, date: '2024-07-26', revenue: 4200, status: 'Em Andamento' },
        ];

        const initialMaintenance = [
            { id: 1, vehicleId: 3, service: 'Troca de Óleo e Filtros', cost: 800, date: '2024-07-26', notes: 'Manutenção preventiva.' },
            { id: 2, vehicleId: 1, service: 'Troca de Pneu', cost: 1200, date: '2024-07-22', notes: '' },
        ];

        const initialCosts = [
            { id: 1, vehicleId: 1, type: 'Seguro', description: 'Renovação anual', value: 1500, date: '2024-07-20' },
            { id: 2, vehicleId: 2, type: 'Impostos', description: 'IPVA', value: 1200, date: '2024-07-15' },
            { id: 3, vehicleId: 1, type: 'Salário', description: 'Salário - João Silva', value: 2500, date: '2024-07-05' },
        ];

        const initialFines = [
            { id: 1, vehicleId: 2, driver: 'Carlos Souza', reason: 'Excesso de Velocidade', value: 195.23, date: '2024-07-24', status: 'Pendente' },
        ];

        const initialDocs = [
            { id: 1, vehicleId: 1, name: 'Licenciamento 2024', expiry: '2024-12-31', status: 'Válido' },
            { id: 2, vehicleId: 2, name: 'Seguro Obrigatório', expiry: '2025-03-15', status: 'Válido' },
        ]

        // Funções de formatação
        const formatCurrency = (value) => {
            if (typeof value !== 'number') value = 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };


        // Componente Modal Genérico
        const Modal = ({ children, isOpen, onClose }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
              <div className="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg relative animate-fade-in-down flex flex-col max-h-[90vh]">
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <div className="overflow-y-auto p-6 pt-12">
                  {children}
                </div>
              </div>
            </div>
          );
        };

        // Componente para Modal de Confirmação
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-[60] flex justify-center items-center p-4">
                    <div className="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 relative animate-fade-in-down border border-gray-700">
                        <h2 className="text-xl font-bold text-white mb-4">{title}</h2>
                        <p className="text-gray-300 mb-6">{message}</p>
                        <div className="flex justify-end gap-4">
                            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                                Cancelar
                            </button>
                            <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente Principal
        function App() {
          const [activeTab, setActiveTab] = React.useState('dashboard');
          
          const [vehicles, setVehicles] = useLocalStorage('vehicles', initialVehicles);
          const [trips, setTrips] = useLocalStorage('trips', initialTrips);
          const [maintenances, setMaintenances] = useLocalStorage('maintenances', initialMaintenance);
          const [costs, setCosts] = useLocalStorage('costs', initialCosts);
          const [fines, setFines] = useLocalStorage('fines', initialFines);
          const [docs, setDocs] = useLocalStorage('docs', initialDocs);
          const [companyName, setCompanyName] = useLocalStorage('companyName', 'Minha Frota');

          const [isFormModalOpen, setIsFormModalOpen] = React.useState(false);
          const [modalContent, setModalContent] = React.useState(null);
          const [editingItem, setEditingItem] = React.useState(null);

          const [isConfirmModalOpen, setIsConfirmModalOpen] = React.useState(false);
          const [itemToDelete, setItemToDelete] = React.useState(null);

          const getVehicleName = (id) => {
            const vehicle = vehicles.find(v => v.id === parseInt(id));
            return vehicle ? vehicle.name : 'Desconhecido';
          };
          
          const handleOpenFormModal = (type, item = null) => {
            setEditingItem(item);
            setModalContent(type);
            setIsFormModalOpen(true);
          };
          
          const handleCloseFormModal = () => {
            setIsFormModalOpen(false);
            setEditingItem(null);
            setModalContent(null);
          };

          const handleSave = (type, data) => {
            const saveData = (setter, items, processedData) => {
                if (editingItem) {
                    setter(items.map(item => item.id === editingItem.id ? { ...item, ...processedData } : item));
                } else {
                    const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
                    setter([...items, { ...processedData, id: newId }]);
                }
            };

            switch (type) {
                case 'vehicle': 
                    saveData(setVehicles, vehicles, data); 
                    break;
                case 'trip':
                    let tripData = { ...data };
                    if (!editingItem) {
                        tripData.status = 'Em Andamento';
                    } else {
                        const originalTrip = trips.find(t => t.id === editingItem.id);
                        if (data.kmFinal && !originalTrip.kmFinal) {
                            tripData.status = 'Finalizada';
                        }
                    }

                    saveData(setTrips, trips, tripData);

                    if (tripData.status === 'Finalizada' && tripData.kmFinal) {
                        const kmFinalValue = parseFloat(tripData.kmFinal);
                        if (!isNaN(kmFinalValue)) {
                            setVehicles(prevVehicles => 
                                prevVehicles.map(vehicle => {
                                    if (vehicle.id === parseInt(tripData.vehicleId)) {
                                        return { ...vehicle, km: kmFinalValue };
                                    }
                                    return vehicle;
                                })
                            );
                        }
                    }
                    break;
                case 'maintenance': 
                    saveData(setMaintenances, maintenances, data); 
                    break;
                case 'cost': 
                    saveData(setCosts, costs, data); 
                    break;
                case 'fine': 
                    saveData(setFines, fines, data); 
                    break;
                case 'doc': 
                    saveData(setDocs, docs, data); 
                    break;
                default: break;
            }
            handleCloseFormModal();
          };
          
          const handleDeleteRequest = (type, id) => {
            setItemToDelete({ type, id });
            setIsConfirmModalOpen(true);
          };
          
          const handleConfirmDelete = () => {
              if (!itemToDelete) return;
              const { type, id } = itemToDelete;

              switch (type) {
                  case 'vehicle': setVehicles(vehicles.filter(item => item.id !== id)); break;
                  case 'trip': setTrips(trips.filter(item => item.id !== id)); break;
                  case 'maintenance': setMaintenances(maintenances.filter(item => item.id !== id)); break;
                  case 'cost': setCosts(costs.filter(item => item.id !== id)); break;
                  case 'fine': setFines(fines.filter(item => item.id !== id)); break;
                  case 'doc': setDocs(docs.filter(item => item.id !== id)); break;
                  default: break;
              }
              setIsConfirmModalOpen(false);
              setItemToDelete(null);
          };


          const renderModalContent = () => {
              const FormComponent = ({ fields, onSubmit, title }) => {
                const initialFormData = editingItem || fields.reduce((acc, field) => ({...acc, [field.name]: field.defaultValue || ''}), {});
                const [formData, setFormData] = React.useState(initialFormData);

                const handleChange = (e) => {
                    const { name, value, type } = e.target;
                    const parsedValue = type === 'number' && value !== '' ? parseFloat(value) : value;
                    setFormData(prev => ({ ...prev, [name]: parsedValue }));
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(modalContent, formData);
                };
                
                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <h2 className="text-2xl font-bold text-white mb-4">{title}</h2>
                        {fields.map(field => (
                            <div key={field.name}>
                                <label className="block text-sm font-medium text-gray-300 mb-1">{field.label}</label>
                                {field.type === 'select' ? (
                                     <select name={field.name} value={formData[field.name] || ''} onChange={handleChange} required={field.required} className="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">{field.placeholder}</option>
                                        {field.options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                    </select>
                                ) : (
                                    <input
                                        type={field.type}
                                        name={field.name}
                                        value={formData[field.name] || ''}
                                        onChange={handleChange}
                                        placeholder={field.placeholder}
                                        required={field.required}
                                        step={field.step}
                                        readOnly={field.readOnly}
                                        className={`w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${field.readOnly ? 'opacity-70' : ''}`}
                                    />
                                )}
                            </div>
                        ))}
                        <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mt-6">
                            Salvar
                        </button>
                    </form>
                );
              };

              const vehicleFields = [
                { name: 'name', label: 'Modelo do Veículo', type: 'text', placeholder: 'Ex: Scania R450', required: true },
                { name: 'plate', label: 'Placa', type: 'text', placeholder: 'Ex: ETS-2024', required: true },
                { name: 'driver', label: 'Motorista Principal', type: 'text', placeholder: 'Ex: João Silva', required: true },
                { name: 'km', label: 'Quilometragem (KM)', type: 'number', placeholder: 'Ex: 125000', required: true },
                { name: 'status', label: 'Status', type: 'select', options: [{value: 'Na Garagem', label: 'Na Garagem'}, {value: 'Em Rota', label: 'Em Rota'}, {value: 'Em Manutenção', label: 'Em Manutenção'}], placeholder: 'Selecione o status', required: true}
              ];
              
              const tripFields = [
                { name: 'vehicleId', label: 'Veículo', type: 'select', options: vehicles.map(v => ({value: v.id, label: `${v.name} (${v.plate})`})), placeholder: 'Selecione o veículo', required: true},
                { name: 'driver', label: 'Motorista', type: 'text', placeholder: 'Nome do motorista', required: true },
                { name: 'client', label: 'Cliente Contratante', type: 'text', placeholder: 'Empresa que contratou o frete', required: true },
                { name: 'cargo', label: 'Nome da Carga', type: 'text', placeholder: 'Ex: Soja, Eletrônicos', required: true },
                { name: 'tonnage', label: 'Toneladas', type: 'number', placeholder: 'Ex: 22', required: true },
                { name: 'origin', label: 'Origem', type: 'text', placeholder: 'Cidade de Origem', required: true },
                { name: 'destination', label: 'Destino', type: 'text', placeholder: 'Cidade de Destino', required: true },
                { name: 'revenue', label: 'Faturamento (R$)', type: 'number', step: '0.01', placeholder: '5000.00', required: true },
                { name: 'kmInicial', label: 'KM Inicial', type: 'number', placeholder: 'KM de partida do veículo', required: true },
                { name: 'kmFinal', label: 'KM Final', type: 'number', placeholder: 'Preencher ao final da viagem', required: false },
                { name: 'fuel', label: 'Combustível Gasto (Litros)', type: 'number', placeholder: '0', required: false },
                { name: 'date', label: 'Data', type: 'date', required: true, defaultValue: new Date().toISOString().slice(0, 10) },
              ];
              
              const maintenanceFields = [
                { name: 'vehicleId', label: 'Veículo', type: 'select', options: vehicles.map(v => ({value: v.id, label: `${v.name} (${v.plate})`})), placeholder: 'Selecione o veículo', required: true},
                { name: 'service', label: 'Serviço Realizado', type: 'text', placeholder: 'Ex: Troca de pneus', required: true },
                { name: 'cost', label: 'Custo (R$)', type: 'number', step: '0.01', placeholder: '800.00', required: true },
                { name: 'date', label: 'Data', type: 'date', required: true },
                { name: 'notes', label: 'Observações', type: 'text', placeholder: 'Detalhes do serviço' },
              ];

              const costFields = [
                  { name: 'vehicleId', label: 'Veículo', type: 'select', options: vehicles.map(v => ({value: v.id, label: `${v.name} (${v.plate})`})), placeholder: 'Selecione o veículo', required: true},
                  { name: 'type', label: 'Tipo de Custo', type: 'select', options: [{value: 'Combustível', label:'Combustível'}, {value: 'Salário', label:'Salário'}, {value: 'Seguro', label:'Seguro'}, {value:'Impostos', label:'Impostos'}, {value:'Peças', label:'Peças'}, {value: 'Outros', label: 'Outros'}], placeholder: 'Selecione um tipo', required: true},
                  { name: 'description', label: 'Descrição', type: 'text', placeholder: 'Ex: Renovação anual do seguro', required: true },
                  { name: 'value', label: 'Valor (R$)', type: 'number', step: '0.01', placeholder: '1500.00', required: true },
                  { name: 'date', label: 'Data', type: 'date', required: true },
              ]

              const fineFields = [
                { name: 'vehicleId', label: 'Veículo', type: 'select', options: vehicles.map(v => ({value: v.id, label: `${v.name} (${v.plate})`})), placeholder: 'Selecione o veículo', required: true},
                { name: 'driver', label: 'Motorista', type: 'text', placeholder: 'Nome do motorista', required: true },
                { name: 'reason', label: 'Motivo da Multa', type: 'text', placeholder: 'Ex: Excesso de velocidade', required: true },
                { name: 'value', label: 'Valor (R$)', type: 'number', step: '0.01', placeholder: '195.23', required: true },
                { name: 'date', label: 'Data da Infração', type: 'date', required: true },
                { name: 'status', label: 'Status', type: 'select', options: [{value: 'Pendente', label: 'Pendente'}, {value: 'Paga', label: 'Paga'}], required: true}
              ];

              const docFields = [
                { name: 'vehicleId', label: 'Veículo', type: 'select', options: vehicles.map(v => ({value: v.id, label: `${v.name} (${v.plate})`})), placeholder: 'Selecione o veículo', required: true},
                { name: 'name', label: 'Nome do Documento', type: 'text', placeholder: 'Ex: Licenciamento 2025', required: true },
                { name: 'expiry', label: 'Data de Vencimento', type: 'date', required: true },
                { name: 'status', label: 'Status', type: 'select', options: [{value: 'Válido', label: 'Válido'}, {value: 'Vencido', label: 'Vencido'}, {value: 'Em Renovação', label: 'Em Renovação'}], required: true}
              ];

              switch(modalContent) {
                case 'vehicle': return <FormComponent fields={vehicleFields} onSubmit={handleSave} title={editingItem ? 'Editar Veículo' : 'Adicionar Veículo'}/>
                case 'trip': return <FormComponent fields={tripFields} onSubmit={handleSave} title={editingItem ? 'Editar Viagem' : 'Adicionar Viagem'}/>
                case 'maintenance': return <FormComponent fields={maintenanceFields} onSubmit={handleSave} title={editingItem ? 'Editar Manutenção' : 'Adicionar Manutenção'}/>
                case 'cost': return <FormComponent fields={costFields} onSubmit={handleSave} title={editingItem ? 'Editar Custo' : 'Adicionar Custo'}/>
                case 'fine': return <FormComponent fields={fineFields} onSubmit={handleSave} title={editingItem ? 'Editar Multa' : 'Adicionar Multa'}/>
                case 'doc': return <FormComponent fields={docFields} onSubmit={handleSave} title={editingItem ? 'Editar Documento' : 'Adicionar Documento'}/>
                default: return null;
              }
          }

          const renderContent = () => {
            switch (activeTab) {
              case 'dashboard': return <DashboardContent />;
              case 'financials': return <FinancialsContent />;
              case 'vehicles': return <VehiclesContent />;
              case 'trips': return <TripsContent />;
              case 'maintenance': return <MaintenanceContent />;
              case 'costs': return <CostsContent />;
              case 'docs': return <DocsContent />;
              case 'fines': return <FinesContent />;
              default: return <DashboardContent />;
            }
          };
          
          const calculateFinancials = () => {
            const totalRevenue = trips.reduce((acc, trip) => acc + (trip.revenue || 0), 0);
            const totalMaintenanceCost = maintenances.reduce((acc, item) => acc + (item.cost || 0), 0);
            const totalOtherCosts = costs.reduce((acc, item) => acc + (item.value || 0), 0);
            const totalFines = fines.reduce((acc, item) => acc + (item.value || 0), 0);
            const totalCosts = totalMaintenanceCost + totalOtherCosts + totalFines;
            const netProfit = totalRevenue - totalCosts;
            return { totalRevenue, totalCosts, netProfit };
          }
          
          const FinancialCard = ({ title, value, colorClass }) => (
            <div className="bg-gray-800 p-6 rounded-xl flex flex-col justify-center text-center">
                <h2 className="text-lg font-semibold text-gray-300 mb-2">{title}</h2>
                <p className={`font-bold text-xl lg:text-2xl whitespace-nowrap ${colorClass}`}>
                    {formatCurrency(value)}
                </p>
            </div>
          );

          const DashboardContent = () => {
              const { totalRevenue, totalCosts, netProfit } = calculateFinancials();
              
              return (
                <div className="animate-fade-in-up">
                    <h1 className="text-3xl font-bold text-white mb-6">Painel de Controle</h1>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-gray-800 p-6 rounded-xl md:col-span-2">
                            <h2 className="text-xl font-semibold text-white mb-3">Resumo da Frota</h2>
                            <div className="flex flex-col sm:flex-row justify-around items-center text-center gap-4">
                                <div>
                                   <p className="text-gray-300">Total de Veículos</p>
                                   <p className="font-bold text-blue-400 text-2xl">{vehicles.length}</p>
                                </div>
                                <div>
                                   <p className="text-gray-300">Em Rota</p>
                                   <p className="font-bold text-green-400 text-2xl">{vehicles.filter(v => v.status === 'Em Rota').length}</p>
                                </div>
                                <div>
                                   <p className="text-gray-300">Em Manutenção</p>
                                   <p className="font-bold text-yellow-400 text-2xl">{vehicles.filter(v => v.status === 'Em Manutenção').length}</p>
                                </div>
                            </div>
                        </div>
                        <FinancialCard title="Faturamento Total" value={totalRevenue} colorClass="text-green-400" />
                        <FinancialCard title="Custo Total" value={totalCosts} colorClass="text-red-400" />
                        <div className="md:col-span-2">
                            <FinancialCard title="Lucro Líquido" value={netProfit} colorClass={netProfit >= 0 ? 'text-green-400' : 'text-red-500'} />
                        </div>
                    </div>
                    <div className="mt-8 bg-gray-800 p-6 rounded-xl">
                        <h2 className="text-xl font-semibold text-white mb-4">Últimas Viagens Registradas</h2>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead><tr className="border-b border-gray-700">
                                        <th className="p-3 text-gray-300">Veículo</th>
                                        <th className="p-3 text-gray-300">Cliente</th>
                                        <th className="p-3 text-gray-300">Faturamento</th>
                                        <th className="p-3 text-gray-300">Data</th>
                                </tr></thead>
                                <tbody>{trips.slice(0, 5).map(trip => (
                                    <tr key={trip.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td className="p-3 text-white">{getVehicleName(trip.vehicleId)}</td>
                                        <td className="p-3 text-white">{trip.client}</td>
                                        <td className="p-3 text-white">{formatCurrency(trip.revenue)}</td>
                                        <td className="p-3 text-white">{formatDate(trip.date)}</td>
                                    </tr>
                                ))}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
              );
          };
          
          const FinancialsContent = () => {
            const data = vehicles.map(vehicle => {
                const vehicleTrips = trips.filter(t => t.vehicleId === vehicle.id);
                const vehicleMaintenance = maintenances.filter(m => m.vehicleId === vehicle.id);
                const vehicleCosts = costs.filter(c => c.vehicleId === vehicle.id);
                const vehicleFines = fines.filter(f => f.vehicleId === vehicle.id);

                const revenue = vehicleTrips.reduce((sum, trip) => sum + (trip.revenue || 0), 0);
                const totalCosts = vehicleMaintenance.reduce((sum, m) => sum + (m.cost || 0), 0) +
                                   vehicleCosts.reduce((sum, c) => sum + (c.value || 0), 0) +
                                   vehicleFines.reduce((sum, f) => sum + (f.value || 0), 0);
                const profit = revenue - totalCosts;

                return { ...vehicle, revenue, totalCosts, profit };
            });
            
            const { totalRevenue, totalCosts, netProfit } = calculateFinancials();

            return (
                <div className="animate-fade-in-up">
                    <h1 className="text-3xl font-bold text-white mb-6">Relatório Financeiro</h1>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <FinancialCard title="Faturamento Total" value={totalRevenue} colorClass="text-green-400" />
                        <FinancialCard title="Custos Totais" value={totalCosts} colorClass="text-red-400" />
                        <div className="md:col-span-2">
                            <FinancialCard title="Lucro Líquido Total" value={netProfit} colorClass={netProfit >= 0 ? 'text-green-400' : 'text-red-500'} />
                        </div>
                    </div>

                    <div className="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                        <h2 className="text-xl font-semibold text-white p-4 bg-gray-900/50">Desempenho por Veículo</h2>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left min-w-[700px]">
                                <thead className="bg-gray-900/50">
                                    <tr>
                                        <th className="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider">Veículo</th>
                                        <th className="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider">Faturamento</th>
                                        <th className="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider">Custos</th>
                                        <th className="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider">Lucro/Prejuízo</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-700">
                                    {data.map(item => (
                                        <tr key={item.id} className="hover:bg-gray-700/50 transition-colors">
                                            <td className="p-4 text-gray-200 font-medium">{item.name} ({item.plate})</td>
                                            <td className="p-4 text-green-400">{formatCurrency(item.revenue)}</td>
                                            <td className="p-4 text-red-400">{formatCurrency(item.totalCosts)}</td>
                                            <td className={`p-4 font-bold ${item.profit >= 0 ? 'text-green-400' : 'text-red-500'}`}>
                                                {formatCurrency(item.profit)}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
          };

          const GenericTable = ({ title, columns, data, onAdd, onEdit, onDelete, type }) => (
            <div className="animate-fade-in-up">
                <div className="flex justify-between items-center mb-6">
                    <h1 className="text-3xl font-bold text-white">{title}</h1>
                    <button onClick={onAdd} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-transform hover:scale-105">
                        <Plus /> <span className="ml-2">Adicionar</span>
                    </button>
                </div>
                <div className="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left min-w-[600px]">
                            <thead className="bg-gray-900/50">
                                <tr>
                                    {columns.map(col => <th key={col.key} className="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider">{col.label}</th>)}
                                    <th className="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-700">
                                {data.map(item => (
                                    <tr key={item.id} className="hover:bg-gray-700/50 transition-colors">
                                        {columns.map(col => (
                                            <td key={col.key} className="p-4 text-gray-200 whitespace-nowrap">
                                                {col.isJsx ? item[col.key] : (item[col.key] !== undefined && item[col.key] !== null) ? item[col.key].toString() : 'N/A'}
                                            </td>
                                        ))}
                                        <td className="p-4 flex gap-3 justify-end">
                                            <button onClick={() => onEdit(item)} className="text-yellow-400 hover:text-yellow-300 transition-colors"><Edit size={18} /></button>
                                            <button onClick={() => onDelete(type, item.id)} className="text-red-500 hover:text-red-400 transition-colors"><Trash2 size={18} /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
          );
          
          const TableView = ({ title, columns, rawData, onAdd, onEdit, onDelete, type, formatItem }) => {
                const displayData = rawData.map(item => formatItem(item));

                const handleEdit = (item) => {
                    const originalItem = rawData.find(i => i.id === item.id);
                    onEdit(originalItem);
                };
                
                return <GenericTable 
                    title={title}
                    columns={columns}
                    data={displayData}
                    onAdd={onAdd}
                    onEdit={handleEdit}
                    onDelete={onDelete}
                    type={type}
                />;
            }

          const VehiclesContent = () => (
              <TableView 
                  title="Meus Veículos"
                  columns={[ { key: 'name', label: 'Modelo' }, { key: 'plate', label: 'Placa' }, { key: 'driver', label: 'Motorista' }, { key: 'km', label: 'KM Atual' }, { key: 'status', label: 'Status' } ]}
                  rawData={vehicles}
                  onAdd={() => handleOpenFormModal('vehicle')}
                  onEdit={(item) => handleOpenFormModal('vehicle', item)}
                  onDelete={handleDeleteRequest}
                  type="vehicle"
                  formatItem={(item) => ({ ...item, km: `${(item.km || 0).toLocaleString('pt-BR')} km` })}
              />
          );

          const TripsContent = () => (
            <TableView
              title="Controle de Viagens"
              columns={[
                  { key: 'status', label: 'Status', isJsx: true }, 
                  { key: 'vehicleName', label: 'Veículo' }, 
                  { key: 'client', label: 'Cliente' },
                  { key: 'cargo', label: 'Carga' },
                  { key: 'tonnage', label: 'Toneladas' },
                  { key: 'revenue', label: 'Faturamento'},
                  { key: 'distance', label: 'Distância'},
                  { key: 'date', label: 'Data' }
              ]}
              rawData={trips}
              onAdd={() => handleOpenFormModal('trip')}
              onEdit={(item) => handleOpenFormModal('trip', item)}
              onDelete={handleDeleteRequest}
              type="trip"
              formatItem={(item) => ({
                  ...item,
                  vehicleName: getVehicleName(item.vehicleId),
                  tonnage: item.tonnage ? `${item.tonnage} t` : '-',
                  revenue: formatCurrency(item.revenue),
                  distance: item.kmFinal ? `${((item.kmFinal || 0) - (item.kmInicial || 0)).toLocaleString('pt-BR')} km` : '-',
                  date: formatDate(item.date),
                  status: (
                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                        item.status === 'Finalizada' ? 'bg-green-500 text-white' : 'bg-yellow-500 text-black'
                    }`}>
                        {item.status}
                    </span>
                  )
              })}
            />
          );
          
          const MaintenanceContent = () => (
              <TableView 
                  title="Histórico de Manutenção"
                  columns={[ { key: 'vehicleName', label: 'Veículo' }, { key: 'service', label: 'Serviço' }, { key: 'cost', label: 'Custo' }, { key: 'date', label: 'Data' }, { key: 'notes', label: 'Observações' } ]}
                  rawData={maintenances}
                  onAdd={() => handleOpenFormModal('maintenance')}
                  onEdit={(item) => handleOpenFormModal('maintenance', item)}
                  onDelete={handleDeleteRequest}
                  type="maintenance"
                  formatItem={(item) => ({ ...item, vehicleName: getVehicleName(item.vehicleId), cost: formatCurrency(item.cost), date: formatDate(item.date) })}
              />
          );
          
          const CostsContent = () => (
              <TableView
                  title="Controle de Custos"
                  columns={[ { key: 'vehicleName', label: 'Veículo' }, { key: 'type', label: 'Tipo' }, { key: 'description', label: 'Descrição' }, { key: 'value', label: 'Valor' }, { key: 'date', label: 'Data' } ]}
                  rawData={costs}
                  onAdd={() => handleOpenFormModal('cost')}
                  onEdit={(item) => handleOpenFormModal('cost', item)}
                  onDelete={handleDeleteRequest}
                  type="cost"
                  formatItem={(item) => ({...item, vehicleName: getVehicleName(item.vehicleId), value: formatCurrency(item.value), date: formatDate(item.date)})}
              />
          );

          const DocsContent = () => (
            <TableView
              title="Documentação"
              columns={[ { key: 'vehicleName', label: 'Veículo' }, { key: 'name', label: 'Documento' }, { key: 'expiry', label: 'Vencimento' }, { key: 'status', label: 'Status' } ]}
              rawData={docs}
              onAdd={() => handleOpenFormModal('doc')}
              onEdit={(item) => handleOpenFormModal('doc', item)}
              onDelete={handleDeleteRequest}
              type="doc"
              formatItem={(item) => ({...item, vehicleName: getVehicleName(item.vehicleId), expiry: formatDate(item.expiry)})}
            />
          );

          const FinesContent = () => (
              <TableView
                  title="Gestão de Multas"
                  columns={[ { key: 'vehicleName', label: 'Veículo' }, { key: 'driver', label: 'Motorista' }, { key: 'reason', label: 'Motivo' }, { key: 'value', label: 'Valor' }, { key: 'date', label: 'Data' }, { key: 'status', label: 'Status' } ]}
                  rawData={fines}
                  onAdd={() => handleOpenFormModal('fine')}
                  onEdit={(item) => handleOpenFormModal('fine', item)}
                  onDelete={handleDeleteRequest}
                  type="fine"
                  formatItem={(item) => ({...item, vehicleName: getVehicleName(item.vehicleId), value: formatCurrency(item.value), date: formatDate(item.date)})}
              />
          );

          const NavItem = ({ icon, label, tabName }) => (
            <li>
              <button onClick={() => setActiveTab(tabName)} className={`flex items-center w-full text-left p-3 rounded-lg transition-all duration-200 ${ activeTab === tabName ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-300 hover:bg-gray-700/50 hover:text-white'}`}>
                {React.createElement(icon, { size: 20 })}
                <span className="ml-4 font-medium">{label}</span>
              </button>
            </li>
          );

          return (
            <div className="bg-gray-900 text-white min-h-screen font-sans flex flex-col md:flex-row">
              <aside className="w-full md:w-64 bg-gray-800 p-4 flex-shrink-0 flex flex-col shadow-2xl">
                <div className="text-center mb-8">
                    <input
                        type="text"
                        value={companyName}
                        onChange={(e) => setCompanyName(e.target.value)}
                        className="text-2xl font-bold text-blue-400 tracking-wider bg-transparent text-center w-full focus:outline-none focus:ring-1 focus:ring-blue-500 rounded-lg p-1"
                        placeholder="Nome da Empresa"
                    />
                </div>
                <nav>
                  <ul className="space-y-2">
                    <NavItem icon={LayoutDashboard} label="Painel" tabName="dashboard" />
                    <NavItem icon={Truck} label="Veículos" tabName="vehicles" />
                    <NavItem icon={Fuel} label="Viagens" tabName="trips" />
                    <NavItem icon={Wrench} label="Manutenção" tabName="maintenance" />
                    <NavItem icon={CircleDollarSign} label="Custos" tabName="costs" />
                    <NavItem icon={FileText} label="Documentos" tabName="docs" />
                    <NavItem icon={AlertTriangle} label="Multas" tabName="fines" />
                    <NavItem icon={TrendingUp} label="Financeiro" tabName="financials" />
                  </ul>
                </nav>
                <div className="mt-auto text-center text-xs text-gray-500 pt-4">
                    <p>Gerenciador de Frota v2.5</p>
                    <p>Desenvolvido por Roni Jesus</p>
                </div>
              </aside>

              <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                {renderContent()}
              </main>

              <Modal isOpen={isFormModalOpen} onClose={handleCloseFormModal}>
                {renderModalContent()}
              </Modal>

              <ConfirmationModal
                isOpen={isConfirmModalOpen}
                onClose={() => setIsConfirmModalOpen(false)}
                onConfirm={handleConfirmDelete}
                title="Confirmar Exclusão"
                message="Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita."
              />
            </div>
          );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>
